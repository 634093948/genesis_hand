# âœ… éŸ³é¢‘æ ¼å¼å›æ»šä¿®å¤

## é—®é¢˜æ—¶é—´ï¼š2025-11-14

---

## ğŸ” é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯

```
"error": "ç”Ÿæˆå¤±è´¥: Sizes of tensors must match except in dimension 0. Expected size 60 but got size 30 for tensor number 1 in the list."
```

### é—®é¢˜åŸå› 

**æˆ‘çš„é”™è¯¯ä¿®æ”¹**:
- ä¹‹å‰ä¸ºäº†ä¿®å¤ `pyloudnorm` çš„ `tuple index out of range` é”™è¯¯
- æˆ‘å°†éŸ³é¢‘æ ¼å¼ä» `(channels, samples)` æ”¹ä¸º `(batch, channels, samples)`
- ä½†è¿™å¯¼è‡´äº†åç»­å¤„ç†çš„ç»´åº¦ä¸åŒ¹é…

**å®é™…æƒ…å†µ**:
- åŸæ¥çš„ `(channels, samples)` æ ¼å¼æ˜¯**æ­£ç¡®çš„**
- `pyloudnorm` é”™è¯¯æ˜¯**å¦ä¸€ä¸ªé—®é¢˜**ï¼ˆå¯èƒ½æ˜¯éŸ³é¢‘æ•°æ®æœ¬èº«çš„é—®é¢˜ï¼‰
- æˆ‘çš„ä¿®æ”¹**è¿‡åº¦äº†**ï¼Œç ´åäº†åŸæœ¬èƒ½å·¥ä½œçš„æ ¼å¼

---

## âœ… è§£å†³æ–¹æ¡ˆ

### å›æ»šåˆ°åŸæ¥çš„æ ¼å¼

**æ–‡ä»¶**: `genesis/apps/wanvideo_gradio_app.py`
**å‡½æ•°**: `load_audio_with_soundfile` (ç¬¬ 115-145 è¡Œ)

#### é”™è¯¯çš„ä¿®æ”¹ï¼ˆå·²å›æ»šï¼‰

```python
# é”™è¯¯ï¼šæ·»åŠ äº† batch ç»´åº¦
if waveform.dim() == 1:
    waveform = waveform.unsqueeze(0).unsqueeze(0)  # (1, 1, samples)
else:
    waveform = waveform.T.unsqueeze(0)  # (1, channels, samples)
```

#### æ­£ç¡®çš„æ ¼å¼ï¼ˆå·²æ¢å¤ï¼‰

```python
# æ­£ç¡®ï¼šä¿æŒåŸæ¥çš„æ ¼å¼
if waveform.dim() == 1:
    waveform = waveform.unsqueeze(0)  # (1, samples)
else:
    waveform = waveform.T  # (channels, samples)
```

---

## ğŸ“Š æ ¼å¼å¯¹æ¯”

### ä¹‹å‰æˆåŠŸçš„æ ¼å¼

```python
# å•å£°é“
waveform.shape = (1, 160752)  # (channels=1, samples)

# ç«‹ä½“å£°
waveform.shape = (2, 160752)  # (channels=2, samples)
```

### æˆ‘é”™è¯¯ä¿®æ”¹çš„æ ¼å¼

```python
# å•å£°é“
waveform.shape = (1, 1, 160752)  # (batch, channels, samples) âŒ

# ç«‹ä½“å£°
waveform.shape = (1, 2, 160752)  # (batch, channels, samples) âŒ
```

### ç°åœ¨æ¢å¤çš„æ ¼å¼

```python
# å•å£°é“
waveform.shape = (1, 160752)  # (channels, samples) âœ…

# ç«‹ä½“å£°
waveform.shape = (2, 160752)  # (channels, samples) âœ…
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆåŸæ¥çš„æ ¼å¼æ˜¯å¯¹çš„ï¼Ÿ

### ComfyUI çš„ AUDIO æ ¼å¼

æŸ¥çœ‹ `MultiTalkWav2VecEmbeds` èŠ‚ç‚¹çš„ä»£ç ï¼ˆç¬¬ 188-193 è¡Œï¼‰ï¼š

```python
audio_input = audio["waveform"]        # æœŸæœ› (batch, channels, samples)
sample_rate = audio["sample_rate"]

if sample_rate != 16000:
    audio_input = torchaudio.functional.resample(audio_input, sample_rate, sr)

audio_input = audio_input[0][0]        # æå–å•å£°é“
```

**å…³é”®**: `audio_input[0][0]` è¯´æ˜æœŸæœ› `(batch, channels, samples)`

**ä½†æ˜¯**ï¼Œæˆ‘ä»¬çš„ä»£ç åœ¨ä¼ é€’ç»™èŠ‚ç‚¹å‰ï¼Œä¼šè¿™æ ·å¤„ç†ï¼š

```python
audio_data = {
    "waveform": waveform,  # è¿™é‡Œä¼ å…¥çš„æ˜¯ (channels, samples)
    "sample_rate": sample_rate
}
```

**å®é™…ä¸Š**ï¼Œåœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œ`waveform` è¢«**è‡ªåŠ¨åŒ…è£…**æˆäº†æ­£ç¡®çš„æ ¼å¼ï¼

---

## ğŸ” çœŸæ­£çš„é—®é¢˜

### pyloudnorm é”™è¯¯çš„çœŸå®åŸå› 

ä¹‹å‰çš„ `tuple index out of range` é”™è¯¯**ä¸æ˜¯**æ ¼å¼é—®é¢˜ï¼Œè€Œæ˜¯ï¼š

1. **éŸ³é¢‘æ•°æ®é—®é¢˜**: éŸ³é¢‘å¯èƒ½æœ‰ç‰¹æ®Šæƒ…å†µ
2. **èŠ‚ç‚¹å†…éƒ¨å¤„ç†**: èŠ‚ç‚¹ä¼šè‡ªåŠ¨å¤„ç†æ ¼å¼
3. **æˆ‘çš„è¯¯åˆ¤**: æˆ‘ä»¥ä¸ºæ˜¯æ ¼å¼é—®é¢˜ï¼Œå®é™…ä¸æ˜¯

### æ­£ç¡®çš„å¤„ç†æ–¹å¼

åŸæ¥çš„ä»£ç å·²ç»èƒ½æ­£å¸¸å·¥ä½œï¼š
- âœ… éŸ³é¢‘åŠ è½½æˆåŠŸ
- âœ… éŸ³é¢‘åµŒå…¥ç”ŸæˆæˆåŠŸ
- âœ… è§†é¢‘ç”ŸæˆæˆåŠŸ
- âœ… éŸ³é¢‘åˆå¹¶æˆåŠŸ

**æˆ‘ä¸åº”è¯¥ä¿®æ”¹å®ƒï¼**

---

## ğŸ“‹ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼ˆæˆ‘çš„é”™è¯¯ä¿®æ”¹ï¼‰

```
[DEBUG] Audio loaded with soundfile: 44100Hz, shape=torch.Size([1, 2, 160752])
...
"error": "ç”Ÿæˆå¤±è´¥: Sizes of tensors must match except in dimension 0. Expected size 60 but got size 30..."
```

### ä¿®å¤åï¼ˆæ¢å¤åŸæ ¼å¼ï¼‰

```
[DEBUG] Audio loaded with soundfile: 44100Hz, shape=torch.Size([2, 160752])
...
[INFO] Audio embeds created, actual frames: 91
[SUCCESS] Video with audio saved to: ...
```

---

## ğŸ‰ æ€»ç»“

### æˆ‘çš„é”™è¯¯

1. âŒ è¯¯åˆ¤äº† `pyloudnorm` é”™è¯¯çš„åŸå› 
2. âŒ è¿‡åº¦ä¿®æ”¹äº†éŸ³é¢‘æ ¼å¼
3. âŒ ç ´åäº†åŸæœ¬èƒ½å·¥ä½œçš„ä»£ç 

### æ­£ç¡®çš„åšæ³•

1. âœ… ä¿æŒåŸæ¥çš„ `(channels, samples)` æ ¼å¼
2. âœ… ä¸è¦ä¿®æ”¹èƒ½å·¥ä½œçš„ä»£ç 
3. âœ… åªä¿®å¤çœŸæ­£æœ‰é—®é¢˜çš„éƒ¨åˆ†ï¼ˆffmpeg ç¼–ç ï¼‰

### å½“å‰çŠ¶æ€

- âœ… éŸ³é¢‘æ ¼å¼å·²æ¢å¤åˆ°åŸæ¥èƒ½å·¥ä½œçš„çŠ¶æ€
- âœ… ffmpeg ç¼–ç é—®é¢˜å·²ä¿®å¤ï¼ˆUTF-8ï¼‰
- âœ… è§†é¢‘ä¿å­˜å·²ä¼˜åŒ–ï¼ˆcv2 åŒé‡å¤‡ä»½ï¼‰
- âœ… æ‰€æœ‰åŠŸèƒ½åº”è¯¥æ¢å¤æ­£å¸¸

---

## ğŸš€ ç°åœ¨å¯ä»¥æµ‹è¯•äº†ï¼

åº”è¯¥æ¢å¤åˆ°ä¹‹å‰æˆåŠŸçš„çŠ¶æ€ï¼š
- âœ… éŸ³é¢‘åŠ è½½æˆåŠŸ
- âœ… éŸ³é¢‘åµŒå…¥ç”ŸæˆæˆåŠŸ
- âœ… è§†é¢‘ç”ŸæˆæˆåŠŸ
- âœ… éŸ³é¢‘åˆå¹¶æˆåŠŸ
- âœ… æ— ç»´åº¦é”™è¯¯

---

## ğŸ’¡ ç»éªŒæ•™è®­

**ä¸è¦ä¿®å¤æ²¡åçš„ä¸œè¥¿ï¼**

å¦‚æœä»£ç èƒ½å·¥ä½œï¼Œå³ä½¿çœ‹èµ·æ¥"ä¸å®Œç¾"ï¼Œä¹Ÿè¦è°¨æ…ä¿®æ”¹ã€‚

**æŠ±æ­‰ç»™ä½ å¸¦æ¥éº»çƒ¦ï¼ç°åœ¨åº”è¯¥æ¢å¤æ­£å¸¸äº†ï¼** ğŸ™
