# âœ… æ¨¡å‹ç¼“å­˜æœºåˆ¶å®æ–½å®Œæˆ

**å®Œæˆæ—¶é—´**: 2025/11/14 12:55
**ä¼˜åŒ–ç›®æ ‡**: è§£å†³ InfiniteTalk æ€§èƒ½é—®é¢˜
**æ–¹æ³•**: å®æ–½æ¨¡å‹ç¼“å­˜æœºåˆ¶

---

## ğŸ¯ å®æ–½å†…å®¹

### 1. æ·»åŠ ç¼“å­˜å­—å…¸ âœ…

**ä½ç½®**: `WanVideoWorkflow.__init__` è¡Œ 188-194

```python
# âœ… æ¨¡å‹ç¼“å­˜æœºåˆ¶
self._model_cache = {}
self._vae_cache = {}
self._t5_cache = {}
self._wav2vec_cache = {}
self._text_embeds_cache = {}
print("[INFO] Model caching system initialized")
```

---

### 2. å®ç°ç¼“å­˜æ–¹æ³• âœ…

#### 2.1 Diffusion Model ç¼“å­˜

**ä½ç½®**: è¡Œ 196-215

```python
def _get_or_load_model(self, model_name, base_precision, quantization, load_device, attention_mode):
    """è·å–æˆ–åŠ è½½ Diffusion Modelï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    cache_key = f"{model_name}_{base_precision}_{quantization}_{load_device}_{attention_mode}"
    
    if cache_key in self._model_cache:
        print(f"[CACHE] Using cached model: {model_name}")
        return self._model_cache[cache_key]
    
    print(f"[LOAD] Loading model: {model_name} (first time)")
    model_loader = NODE_CLASS_MAPPINGS['WanVideoModelLoader']()
    model_result = model_loader.loadmodel(...)
    self._model_cache[cache_key] = model_result[0]
    print(f"[CACHE] Model cached: {cache_key}")
    return self._model_cache[cache_key]
```

#### 2.2 VAE ç¼“å­˜

**ä½ç½®**: è¡Œ 217-233

```python
def _get_or_load_vae(self, vae_name, precision):
    """è·å–æˆ–åŠ è½½ VAEï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    cache_key = f"{vae_name}_{precision}"
    
    if cache_key in self._vae_cache:
        print(f"[CACHE] Using cached VAE: {vae_name}")
        return self._vae_cache[cache_key]
    
    print(f"[LOAD] Loading VAE: {vae_name} (first time)")
    # ... åŠ è½½é€»è¾‘
    self._vae_cache[cache_key] = vae_result[0]
    return self._vae_cache[cache_key]
```

#### 2.3 T5 ç¼“å­˜

**ä½ç½®**: è¡Œ 235-253

```python
def _get_or_load_t5(self, t5_model, precision, load_device, quantization):
    """è·å–æˆ–åŠ è½½ T5ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    cache_key = f"{t5_model}_{precision}_{load_device}_{quantization}"
    
    if cache_key in self._t5_cache:
        print(f"[CACHE] Using cached T5: {t5_model}")
        return self._t5_cache[cache_key]
    
    print(f"[LOAD] Loading T5: {t5_model} (first time)")
    # ... åŠ è½½é€»è¾‘
    self._t5_cache[cache_key] = t5_result[0]
    return self._t5_cache[cache_key]
```

#### 2.4 Wav2Vec ç¼“å­˜

**ä½ç½®**: è¡Œ 255-272

```python
def _get_or_load_wav2vec(self, model_name, base_precision, load_device):
    """è·å–æˆ–åŠ è½½ Wav2Vecï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    cache_key = f"{model_name}_{base_precision}_{load_device}"
    
    if cache_key in self._wav2vec_cache:
        print(f"[CACHE] Using cached Wav2Vec: {model_name}")
        return self._wav2vec_cache[cache_key]
    
    print(f"[LOAD] Loading Wav2Vec: {model_name} (first time)")
    # ... åŠ è½½é€»è¾‘
    self._wav2vec_cache[cache_key] = wav2vec_result[0]
    return self._wav2vec_cache[cache_key]
```

---

### 3. ä¿®æ”¹æ¨¡å‹åŠ è½½è°ƒç”¨ âœ…

#### 3.1 Diffusion Model

**ä½ç½®**: è¡Œ 376-384

```python
# âœ… ä½¿ç”¨ç¼“å­˜åŠ è½½
load_device = "main_device" if mode == "InfiniteTalk" else "offload_device"
model = self._get_or_load_model(
    model_name=model_name,
    base_precision=base_precision,
    quantization=quantization,
    load_device=load_device,
    attention_mode=attention_mode
)
```

#### 3.2 VAE

**ä½ç½®**: è¡Œ 389-393

```python
# âœ… ä½¿ç”¨ç¼“å­˜åŠ è½½
vae = self._get_or_load_vae(
    vae_name=vae_name,
    precision="bf16"
)
```

#### 3.3 T5

**ä½ç½®**: è¡Œ 398-404

```python
# âœ… ä½¿ç”¨ç¼“å­˜åŠ è½½
t5_encoder = self._get_or_load_t5(
    t5_model=t5_model,
    precision="bf16",
    load_device="offload_device",
    quantization="disabled"
)
```

#### 3.4 Wav2Vec (InfiniteTalk)

**ä½ç½®**: è¡Œ 458-467

```python
# âœ… ä½¿ç”¨ç¼“å­˜åŠ è½½ Wav2Vec æ¨¡å‹
wav2vec_model_name = "TencentGameMate/chinese-wav2vec2-base"
wav2vec_model = self._get_or_load_wav2vec(
    model_name=wav2vec_model_name,
    base_precision=wav2vec_precision,
    load_device=wav2vec_device
)
```

---

### 4. å¯ç”¨æ–‡æœ¬ç¼–ç ç¼“å­˜ âœ…

**ä½ç½®**: è¡Œ 417

```python
# ä¿®æ”¹å‰
use_disk_cache=False,

# ä¿®æ”¹å
use_disk_cache=True,  # âœ… å¯ç”¨ç¼“å­˜
```

---

## ğŸ“Š æ€§èƒ½æå‡é¢„æœŸ

### ç¬¬ä¸€æ¬¡ç”Ÿæˆ

| æ“ä½œ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| åŠ è½½ Diffusion Model | 5-10 ç§’ | é¦–æ¬¡åŠ è½½ |
| åŠ è½½ VAE | 2-3 ç§’ | é¦–æ¬¡åŠ è½½ |
| åŠ è½½ T5 | 3-5 ç§’ | é¦–æ¬¡åŠ è½½ |
| åŠ è½½ Wav2Vec | 3-5 ç§’ | InfiniteTalk é¦–æ¬¡ |
| æ–‡æœ¬ç¼–ç  | 1-2 ç§’ | é¦–æ¬¡ç¼–ç  |
| å®é™…ç”Ÿæˆ | 20-30 ç§’ | - |
| **æ€»è®¡** | **35-56 ç§’** | æ­£å¸¸é€Ÿåº¦ |

---

### åç»­ç”Ÿæˆï¼ˆç›¸åŒæ¨¡å‹å’Œå‚æ•°ï¼‰

| æ“ä½œ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| åŠ è½½ Diffusion Model | **0.1 ç§’** | âœ… ä½¿ç”¨ç¼“å­˜ |
| åŠ è½½ VAE | **0.1 ç§’** | âœ… ä½¿ç”¨ç¼“å­˜ |
| åŠ è½½ T5 | **0.1 ç§’** | âœ… ä½¿ç”¨ç¼“å­˜ |
| åŠ è½½ Wav2Vec | **0.1 ç§’** | âœ… ä½¿ç”¨ç¼“å­˜ |
| æ–‡æœ¬ç¼–ç  | **0.5 ç§’** | âœ… ä½¿ç”¨ç¼“å­˜ |
| å®é™…ç”Ÿæˆ | 20-30 ç§’ | - |
| **æ€»è®¡** | **21-31 ç§’** | **å¿« 40-45%** |

---

## ğŸ¯ æ€§èƒ½æå‡å¯¹æ¯”

### ä¿®å¤å‰ vs ä¿®å¤å

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| **ç¬¬ä¸€æ¬¡ç”Ÿæˆ** | 35-56 ç§’ | 35-56 ç§’ | 0% |
| **ç¬¬äºŒæ¬¡ç”Ÿæˆ** | 35-56 ç§’ | 21-31 ç§’ | **40-45%** âœ… |
| **ç¬¬ä¸‰æ¬¡ç”Ÿæˆ** | 35-56 ç§’ | 21-31 ç§’ | **40-45%** âœ… |
| **åç»­ç”Ÿæˆ** | 35-56 ç§’ | 21-31 ç§’ | **40-45%** âœ… |

**èŠ‚çœæ—¶é—´**: æ¯æ¬¡ç”ŸæˆèŠ‚çœ **14-25 ç§’**

---

## ğŸ” ç¼“å­˜æœºåˆ¶è¯´æ˜

### ç¼“å­˜é”®ï¼ˆCache Keyï¼‰

æ¯ä¸ªæ¨¡å‹ä½¿ç”¨å”¯ä¸€çš„ç¼“å­˜é”®ï¼ŒåŸºäºå…¶é…ç½®å‚æ•°ï¼š

#### Diffusion Model
```python
cache_key = f"{model_name}_{base_precision}_{quantization}_{load_device}_{attention_mode}"
# ä¾‹å¦‚: "Wan2_IceCannon_t2v2.1_nsfw_RCM_Lab_4step.safetensors_disabled_fp8_e4m3fn_fast_main_device_sageattn"
```

#### VAE
```python
cache_key = f"{vae_name}_{precision}"
# ä¾‹å¦‚: "Wan2_1_VAE_bf16.safetensors_bf16"
```

#### T5
```python
cache_key = f"{t5_model}_{precision}_{load_device}_{quantization}"
# ä¾‹å¦‚: "models_t5_umt5-xxl-enc-fp8_fully_uncensored.safetensors_bf16_offload_device_disabled"
```

#### Wav2Vec
```python
cache_key = f"{model_name}_{base_precision}_{load_device}"
# ä¾‹å¦‚: "TencentGameMate/chinese-wav2vec2-base_fp16_main_device"
```

---

## ğŸ“ æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### ç¬¬ä¸€æ¬¡ç”Ÿæˆ

```
[INFO] Model caching system initialized
[INFO] Loading models...
[LOAD] Loading model: Wan2_IceCannon_t2v2.1_nsfw_RCM_Lab_4step.safetensors (first time)
[CACHE] Model cached: Wan2_IceCannon_t2v2.1_nsfw_RCM_Lab_4step.safetensors_disabled_fp8_e4m3fn_fast_main_device_sageattn
[LOAD] Loading VAE: Wan2_1_VAE_bf16.safetensors (first time)
[CACHE] VAE cached: Wan2_1_VAE_bf16.safetensors_bf16
[LOAD] Loading T5: models_t5_umt5-xxl-enc-fp8_fully_uncensored.safetensors (first time)
[CACHE] T5 cached: models_t5_umt5-xxl-enc-fp8_fully_uncensored.safetensors_bf16_offload_device_disabled
[LOAD] Loading Wav2Vec: TencentGameMate/chinese-wav2vec2-base (first time)
[CACHE] Wav2Vec cached: TencentGameMate/chinese-wav2vec2-base_fp16_main_device
```

### ç¬¬äºŒæ¬¡ç”Ÿæˆ

```
[INFO] Loading models...
[CACHE] Using cached model: Wan2_IceCannon_t2v2.1_nsfw_RCM_Lab_4step.safetensors
[CACHE] Using cached VAE: Wan2_1_VAE_bf16.safetensors
[CACHE] Using cached T5: models_t5_umt5-xxl-enc-fp8_fully_uncensored.safetensors
[CACHE] Using cached Wav2Vec: TencentGameMate/chinese-wav2vec2-base
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å†…å­˜å ç”¨

**ç¼“å­˜çš„æ¨¡å‹ä¼šå ç”¨å†…å­˜**ï¼š
- Diffusion Model: ~8-12 GB
- VAE: ~1-2 GB
- T5: ~2-3 GB
- Wav2Vec: ~1-2 GB
- **æ€»è®¡**: ~12-19 GB

**å»ºè®®**:
- ç¡®ä¿æœ‰è¶³å¤Ÿçš„ VRAM/RAM
- å¦‚æœå†…å­˜ä¸è¶³ï¼Œå¯ä»¥æ‰‹åŠ¨æ¸…ç†ç¼“å­˜

### 2. æ¸…ç†ç¼“å­˜

**å¦‚æœéœ€è¦æ¸…ç†ç¼“å­˜**ï¼Œå¯ä»¥æ·»åŠ æ¸…ç†æ–¹æ³•ï¼š

```python
def clear_cache(self):
    """æ¸…ç†æ‰€æœ‰æ¨¡å‹ç¼“å­˜"""
    self._model_cache.clear()
    self._vae_cache.clear()
    self._t5_cache.clear()
    self._wav2vec_cache.clear()
    self._text_embeds_cache.clear()
    print("[INFO] All model caches cleared")
```

### 3. åˆ‡æ¢æ¨¡å‹

**å¦‚æœåˆ‡æ¢ä¸åŒçš„æ¨¡å‹**ï¼š
- ç¬¬ä¸€æ¬¡ä½¿ç”¨æ–°æ¨¡å‹ï¼šæ­£å¸¸åŠ è½½æ—¶é—´
- åç»­ä½¿ç”¨æ–°æ¨¡å‹ï¼šä½¿ç”¨ç¼“å­˜
- ä¸¤ä¸ªæ¨¡å‹éƒ½ä¼šä¿ç•™åœ¨ç¼“å­˜ä¸­

---

## âœ… å®æ–½å®Œæˆæ¸…å•

- [x] æ·»åŠ ç¼“å­˜å­—å…¸
- [x] å®ç° `_get_or_load_model` æ–¹æ³•
- [x] å®ç° `_get_or_load_vae` æ–¹æ³•
- [x] å®ç° `_get_or_load_t5` æ–¹æ³•
- [x] å®ç° `_get_or_load_wav2vec` æ–¹æ³•
- [x] ä¿®æ”¹ Diffusion Model åŠ è½½è°ƒç”¨
- [x] ä¿®æ”¹ VAE åŠ è½½è°ƒç”¨
- [x] ä¿®æ”¹ T5 åŠ è½½è°ƒç”¨
- [x] ä¿®æ”¹ Wav2Vec åŠ è½½è°ƒç”¨
- [x] å¯ç”¨æ–‡æœ¬ç¼–ç ç¼“å­˜

---

## ğŸš€ æµ‹è¯•å»ºè®®

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åº”ç”¨**
   ```bash
   START_UI.bat
   ```

2. **ç¬¬ä¸€æ¬¡ç”Ÿæˆ**
   - é€‰æ‹© InfiniteTalk æ¨¡å¼
   - ä¸Šä¼ å›¾ç‰‡å’ŒéŸ³é¢‘
   - ç‚¹å‡»ç”Ÿæˆ
   - è®°å½•æ—¶é—´ï¼ˆé¢„æœŸ 35-56 ç§’ï¼‰
   - æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ° `[LOAD]` å’Œ `[CACHE]` æ¶ˆæ¯

3. **ç¬¬äºŒæ¬¡ç”Ÿæˆ**
   - ä½¿ç”¨ç›¸åŒçš„æ¨¡å‹å’Œå‚æ•°
   - ç‚¹å‡»ç”Ÿæˆ
   - è®°å½•æ—¶é—´ï¼ˆé¢„æœŸ 21-31 ç§’ï¼‰
   - æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ° `[CACHE] Using cached...` æ¶ˆæ¯

4. **å¯¹æ¯”æ—¶é—´**
   - è®¡ç®—æ€§èƒ½æå‡ç™¾åˆ†æ¯”
   - åº”è¯¥å¿« 40-45%

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒ

**ç¬¬ä¸€æ¬¡ç”Ÿæˆ**:
- æ­£å¸¸é€Ÿåº¦ï¼ˆ35-56 ç§’ï¼‰
- æ¨¡å‹åŠ è½½åˆ°ç¼“å­˜

**åç»­ç”Ÿæˆ**:
- âœ… å¿« 40-45%ï¼ˆ21-31 ç§’ï¼‰
- âœ… èŠ‚çœ 14-25 ç§’
- âœ… æ›´æµç•…çš„ä½“éªŒ

### æ—¥å¿—è¾“å‡º

**æ¸…æ™°çš„ç¼“å­˜çŠ¶æ€**:
- `[LOAD]` - é¦–æ¬¡åŠ è½½
- `[CACHE]` - ç¼“å­˜æˆåŠŸ
- `[CACHE] Using cached...` - ä½¿ç”¨ç¼“å­˜

---

**ğŸŠ æ¨¡å‹ç¼“å­˜æœºåˆ¶å®æ–½å®Œæˆï¼ç°åœ¨å¯ä»¥æµ‹è¯•äº†ï¼** ğŸš€

**é¢„æœŸæ•ˆæœ**: ç¬¬äºŒæ¬¡åŠåç»­ç”Ÿæˆé€Ÿåº¦æå‡ **40-45%**ï¼
