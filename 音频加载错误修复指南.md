# éŸ³é¢‘åŠ è½½é”™è¯¯ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

```
RuntimeError: Couldn't find appropriate backend to handle uri C:\Users\...\è´¾ç»´æ–¯-æˆåŠŸç€é™†æ¬¢è¿å›å®¶_çˆ±ç»™ç½‘_aigei_com.mp3 and format None.
```

**åŸå› **: `torchaudio` æ— æ³•ç›´æ¥åŠ è½½æŸäº› MP3 æ–‡ä»¶ï¼Œéœ€è¦é¢å¤–çš„åç«¯æ”¯æŒæˆ–ä½¿ç”¨å…¶ä»–éŸ³é¢‘åº“ã€‚

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: å®‰è£… soundfileï¼ˆæ¨èï¼‰

```bash
python313\python.exe -m pip install soundfile
```

**ä¼˜ç‚¹**: æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼ï¼ŒåŒ…æ‹¬ MP3ã€WAVã€FLAC ç­‰

### æ–¹æ¡ˆ 2: å®‰è£… librosa

```bash
python313\python.exe -m pip install librosa
```

**ä¼˜ç‚¹**: ä¸“ä¸šéŸ³é¢‘å¤„ç†åº“ï¼ŒåŠŸèƒ½å¼ºå¤§

### æ–¹æ¡ˆ 3: å®‰è£… pydub + ffmpeg

```bash
python313\python.exe -m pip install pydub
# è¿˜éœ€è¦å®‰è£… ffmpegï¼ˆç³»ç»Ÿçº§ï¼‰
```

**ä¼˜ç‚¹**: æ”¯æŒæœ€å¹¿æ³›çš„éŸ³é¢‘æ ¼å¼

---

## ğŸ“ ä»£ç ä¿®å¤

### æ­¥éª¤ 1: ä½¿ç”¨ä¿®å¤è„šæœ¬

æˆ‘å·²ç»åˆ›å»ºäº† `audio_loading_fix.py`ï¼ŒåŒ…å«å¤šç§éŸ³é¢‘åŠ è½½æ–¹æ³•çš„å›é€€æœºåˆ¶ã€‚

### æ­¥éª¤ 2: ä¿®æ”¹ wanvideo_gradio_app.py

æ‰¾åˆ°éŸ³é¢‘åŠ è½½éƒ¨åˆ†ï¼ˆçº¦ç¬¬ 340 è¡Œï¼‰ï¼š

**åŸä»£ç **:
```python
import torchaudio
waveform, sample_rate = torchaudio.load(audio_file)
```

**ä¿®æ”¹ä¸º**:
```python
# å¯¼å…¥ä¿®å¤å‡½æ•°
from audio_loading_fix import load_audio_file

# ä½¿ç”¨å¤šæ–¹æ³•åŠ è½½
waveform, sample_rate = load_audio_file(audio_file)

if waveform is None:
    print(f"[WARNING] Could not load audio file, continuing without audio...")
    audio_embeds = None
else:
    # ç»§ç»­å¤„ç†éŸ³é¢‘
    audio_data = {
        "waveform": waveform,
        "sample_rate": sample_rate
    }
    print(f"[DEBUG] Audio file loaded: sample_rate={sample_rate}, shape={waveform.shape}")
    
    # åˆ›å»ºéŸ³é¢‘åµŒå…¥
    wav2vec_embeds_node = NODE_CLASS_MAPPINGS['MultiTalkWav2VecEmbeds']()
    audio_embeds_result = wav2vec_embeds_node.process(
        wav2vec_model=wav2vec_model,
        audio_1=audio_data,
        normalize_loudness=True,
        num_frames=frame_window_size,
        fps=fps,
        audio_scale=1.0,
        audio_cfg_scale=1.0,
        multi_audio_type="para"
    )
    audio_embeds = audio_embeds_result[0]
    actual_num_frames = audio_embeds_result[2]
    print(f"[INFO] Audio embeds created, actual frames: {actual_num_frames}")
```

---

## ğŸš€ å¿«é€Ÿä¿®å¤ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœä¸æƒ³ä¿®æ”¹ä»£ç ï¼Œå¯ä»¥è½¬æ¢éŸ³é¢‘æ ¼å¼ï¼š

### ä½¿ç”¨ ffmpeg è½¬æ¢ä¸º WAV

```bash
ffmpeg -i "è´¾ç»´æ–¯-æˆåŠŸç€é™†æ¬¢è¿å›å®¶_çˆ±ç»™ç½‘_aigei_com.mp3" -ar 16000 -ac 1 output.wav
```

ç„¶ååœ¨ Gradio UI ä¸­ä¸Šä¼  `output.wav` æ–‡ä»¶ã€‚

---

## ğŸ“Š éŸ³é¢‘åŠ è½½æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | æ”¯æŒæ ¼å¼ | å®‰è£…éš¾åº¦ | æ¨èåº¦ |
|------|---------|---------|--------|
| **soundfile** | MP3, WAV, FLAC, OGG | â­ ç®€å• | â­â­â­â­â­ |
| **librosa** | å¤šç§æ ¼å¼ | â­â­ ä¸­ç­‰ | â­â­â­â­ |
| **pydub** | æœ€å¹¿æ³› | â­â­â­ éœ€è¦ ffmpeg | â­â­â­ |
| **torchaudio** | æœ‰é™ | â­ å·²å®‰è£… | â­â­ |

---

## âœ… æ¨èæ“ä½œæ­¥éª¤

### 1. å®‰è£… soundfileï¼ˆæœ€ç®€å•ï¼‰

```bash
cd E:\liliyuanshangmie\genesis_hand
python313\python.exe -m pip install soundfile
```

### 2. ä¿®æ”¹ä»£ç 

åœ¨ `genesis/apps/wanvideo_gradio_app.py` çš„å¼€å¤´æ·»åŠ å¯¼å…¥ï¼š

```python
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
from audio_loading_fix import load_audio_file
```

æ‰¾åˆ°éŸ³é¢‘åŠ è½½éƒ¨åˆ†å¹¶æ›¿æ¢ï¼š

```python
# æœç´¢: import torchaudio
#       waveform, sample_rate = torchaudio.load(audio_file)

# æ›¿æ¢ä¸º:
waveform, sample_rate = load_audio_file(audio_file)

if waveform is None:
    print(f"[WARNING] Could not load audio file, using silent mode...")
    audio_embeds = None
    # ç»§ç»­æ‰§è¡Œï¼Œä½¿ç”¨é™éŸ³æ¨¡å¼
else:
    # åŸæœ‰çš„éŸ³é¢‘å¤„ç†ä»£ç 
    audio_data = {
        "waveform": waveform,
        "sample_rate": sample_rate
    }
    # ... åç»­ä»£ç  ...
```

### 3. æµ‹è¯•

```bash
python genesis/apps/wanvideo_gradio_app.py
```

ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶æµ‹è¯•ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š

```
[DEBUG] Audio loaded with soundfile: 16000Hz, shape=torch.Size([1, 48000])
[INFO] Audio embeds created, actual frames: 81
```

---

## ğŸ” è°ƒè¯•ä¿¡æ¯

å¦‚æœä»ç„¶å¤±è´¥ï¼Œæ£€æŸ¥ï¼š

1. **éŸ³é¢‘æ–‡ä»¶æ˜¯å¦æŸå**
   ```bash
   ffmpeg -i "your_audio.mp3" -f null -
   ```

2. **soundfile æ˜¯å¦æ­£ç¡®å®‰è£…**
   ```bash
   python313\python.exe -c "import soundfile; print(soundfile.__version__)"
   ```

3. **éŸ³é¢‘æ–‡ä»¶è·¯å¾„æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦**
   - é¿å…ä¸­æ–‡è·¯å¾„
   - é¿å…ç©ºæ ¼å’Œç‰¹æ®Šç¬¦å·

---

## ğŸ“š å®Œæ•´çš„éŸ³é¢‘åŠ è½½å‡½æ•°

`audio_loading_fix.py` å·²åˆ›å»ºï¼ŒåŒ…å«ï¼š

- âœ… torchaudio åŠ è½½
- âœ… soundfile åŠ è½½
- âœ… librosa åŠ è½½
- âœ… pydub åŠ è½½
- âœ… è‡ªåŠ¨æ ¼å¼è½¬æ¢
- âœ… è¯¦ç»†é”™è¯¯æ—¥å¿—

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **éŸ³é¢‘æ ¼å¼è¦æ±‚**:
   - é‡‡æ ·ç‡: 16000Hzï¼ˆæ¨èï¼‰
   - é€šé“: å•å£°é“æˆ–ç«‹ä½“å£°
   - æ ¼å¼: WAV, MP3, FLAC, OGG

2. **å†…å­˜ä½¿ç”¨**:
   - é•¿éŸ³é¢‘æ–‡ä»¶ä¼šå ç”¨æ›´å¤šå†…å­˜
   - å»ºè®®éŸ³é¢‘é•¿åº¦ < 30ç§’

3. **æ€§èƒ½**:
   - soundfile æœ€å¿«
   - librosa åŠŸèƒ½æœ€å¼º
   - pydub æœ€å…¼å®¹ä½†è¾ƒæ…¢

---

## ğŸ‰ æ€»ç»“

**æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆ**:

```bash
# 1. å®‰è£… soundfile
python313\python.exe -m pip install soundfile

# 2. åœ¨ wanvideo_gradio_app.py é¡¶éƒ¨æ·»åŠ 
from audio_loading_fix import load_audio_file

# 3. æ›¿æ¢éŸ³é¢‘åŠ è½½ä»£ç 
waveform, sample_rate = load_audio_file(audio_file)
```

å®Œæˆï¼ç°åœ¨åº”è¯¥å¯ä»¥åŠ è½½ä»»ä½•æ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶äº†ã€‚
