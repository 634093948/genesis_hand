# âœ… ffmpeg ç¼–ç é”™è¯¯ä¿®å¤å®Œæˆ

## ä¿®å¤æ—¶é—´ï¼š2025-11-14

---

## ğŸ” é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯

```
Exception in thread Thread-7 (_readerthread):
Traceback (most recent call last):
  File "subprocess.py", line 1609, in _readerthread
UnicodeDecodeError: 'gbk' codec can't decode byte 0xaf in position 2682: illegal multibyte sequence
```

### é—®é¢˜åŸå› 

**ç¼–ç ä¸åŒ¹é…**:
- ffmpeg è¾“å‡ºä½¿ç”¨ **UTF-8** æˆ–æ··åˆç¼–ç 
- Python subprocess é»˜è®¤ä½¿ç”¨ç³»ç»Ÿç¼–ç  **GBK** (Windows ä¸­æ–‡)
- å½“é‡åˆ° UTF-8 å­—èŠ‚æ—¶ï¼ŒGBK è§£ç å¤±è´¥

### å½±å“èŒƒå›´

- âœ… **è§†é¢‘ç”Ÿæˆ**: ä¸å—å½±å“ï¼ˆå·²æˆåŠŸï¼‰
- âœ… **éŸ³é¢‘åˆå¹¶**: ä¸å—å½±å“ï¼ˆå·²æˆåŠŸï¼‰
- âŒ **æ§åˆ¶å°æ—¥å¿—**: å‡ºç°å¼‚å¸¸ä¿¡æ¯
- âŒ **è°ƒè¯•ä½“éªŒ**: åå°çº¿ç¨‹æŠ¥é”™

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶**: `genesis/apps/wanvideo_gradio_app.py`
**ä½ç½®**: ç¬¬ 740-747 è¡Œ

#### ä¿®æ”¹å‰

```python
result = subprocess.run(cmd, check=True, capture_output=True, text=True)
```

#### ä¿®æ”¹å

```python
result = subprocess.run(
    cmd, 
    check=True, 
    capture_output=True, 
    text=True,
    encoding='utf-8',    # ä½¿ç”¨ UTF-8 ç¼–ç é¿å… GBK è§£ç é”™è¯¯
    errors='replace'     # é‡åˆ°æ— æ³•è§£ç çš„å­—ç¬¦æ›¿æ¢ä¸º ï¿½ï¼Œä¸ä¼šå´©æºƒ
)
```

---

## ğŸ¯ ä¿®å¤åŸç†

### å‚æ•°è¯´æ˜

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `encoding` | `'utf-8'` | æŒ‡å®šä½¿ç”¨ UTF-8 è§£ç  ffmpeg è¾“å‡º |
| `errors` | `'replace'` | é‡åˆ°æ— æ³•è§£ç çš„å­—ç¬¦ç”¨ ï¿½ æ›¿æ¢ï¼Œè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸ |

### å·¥ä½œæµç¨‹

```
ffmpeg è¾“å‡º (UTF-8/æ··åˆç¼–ç )
    â†“
subprocess è¯»å–
    â†“
ä½¿ç”¨ UTF-8 è§£ç 
    â†“ (å¦‚æœé‡åˆ°æ— æ³•è§£ç çš„å­—ç¬¦)
æ›¿æ¢ä¸º ï¿½ (ä¸å´©æºƒ)
    â†“
è¿”å›ç»™ Python
```

---

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
[INFO] Merging audio with video using ffmpeg...
[SUCCESS] Video with audio saved to: infinitetalk_xxx.mp4
Exception in thread Thread-7 (_readerthread):
UnicodeDecodeError: 'gbk' codec can't decode byte 0xaf...
```

### ä¿®å¤å

```
[INFO] Merging audio with video using ffmpeg...
[SUCCESS] Video with audio saved to: infinitetalk_xxx.mp4
(æ— å¼‚å¸¸ä¿¡æ¯ï¼Œå¹²å‡€çš„è¾“å‡º)
```

---

## ğŸ“‹ å½±å“åˆ†æ

### âœ… å®Œå…¨ä¸å½±å“çš„éƒ¨åˆ†

1. **è§†é¢‘ç”Ÿæˆé€»è¾‘**: å®Œå…¨ä¸å˜
2. **éŸ³é¢‘åˆå¹¶é€»è¾‘**: å®Œå…¨ä¸å˜
3. **æ–‡ä»¶ä¿å­˜**: å®Œå…¨ä¸å˜
4. **é”™è¯¯å¤„ç†**: å®Œå…¨ä¸å˜ï¼ˆ`check=True` ä»ç„¶æœ‰æ•ˆï¼‰
5. **ffmpeg å‘½ä»¤**: å®Œå…¨ä¸å˜
6. **æ€§èƒ½**: å®Œå…¨ä¸å˜

### âœ… æ”¹å–„çš„éƒ¨åˆ†

1. **æ§åˆ¶å°è¾“å‡º**: ä¸å†å‡ºç° `UnicodeDecodeError`
2. **è°ƒè¯•ä½“éªŒ**: å¯ä»¥æ­£å¸¸æŸ¥çœ‹ ffmpeg è¾“å‡º
3. **ç¨³å®šæ€§**: é¿å…åå°çº¿ç¨‹å¼‚å¸¸
4. **æ—¥å¿—è´¨é‡**: æ›´å¹²å‡€ï¼Œæ›´ä¸“ä¸š

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. âœ… é‡æ–°å¯åŠ¨åº”ç”¨
2. âœ… é€‰æ‹© InfiniteTalk æ¨¡å¼
3. âœ… ä¸Šä¼ å›¾ç‰‡å’ŒéŸ³é¢‘
4. âœ… ç”Ÿæˆè§†é¢‘
5. âœ… æ£€æŸ¥æ§åˆ¶å°è¾“å‡º

### é¢„æœŸç»“æœ

- âœ… è§†é¢‘ç”ŸæˆæˆåŠŸ
- âœ… éŸ³é¢‘åˆå¹¶æˆåŠŸ
- âœ… è§†é¢‘æœ‰å£°éŸ³
- âœ… å˜´å‹åŒæ­¥
- âœ… **æ§åˆ¶å°æ—  UnicodeDecodeError**

---

## ğŸ¯ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆé€‰æ‹© UTF-8ï¼Ÿ

1. **é€šç”¨æ€§**: UTF-8 æ˜¯å›½é™…æ ‡å‡†ç¼–ç 
2. **å…¼å®¹æ€§**: æ”¯æŒæ‰€æœ‰è¯­è¨€å­—ç¬¦
3. **ffmpeg é»˜è®¤**: ffmpeg è¾“å‡ºé€šå¸¸æ˜¯ UTF-8
4. **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½

### ä¸ºä»€ä¹ˆä½¿ç”¨ errors='replace'ï¼Ÿ

| æ¨¡å¼ | è¡Œä¸º | ä¼˜ç¼ºç‚¹ |
|------|------|--------|
| `'strict'` | é‡åˆ°é”™è¯¯æŠ›å‡ºå¼‚å¸¸ | âŒ ä¼šå´©æºƒ |
| `'ignore'` | å¿½ç•¥æ— æ³•è§£ç çš„å­—ç¬¦ | âš ï¸ ä¸¢å¤±ä¿¡æ¯ |
| `'replace'` | æ›¿æ¢ä¸º ï¿½ | âœ… ä¸å´©æºƒï¼Œä¿ç•™ä½ç½® |

### å…¶ä»–å¯é€‰æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: ä¸æ•è·è¾“å‡ºï¼ˆæ›´ç®€å•ï¼‰

```python
result = subprocess.run(cmd, check=True, capture_output=False)
```

**ä¼˜ç‚¹**: å®Œå…¨é¿å…è§£ç é—®é¢˜
**ç¼ºç‚¹**: æ— æ³•æ•è·é”™è¯¯ä¿¡æ¯

#### æ–¹æ¡ˆ 2: bytes æ¨¡å¼ï¼ˆæ›´çµæ´»ï¼‰

```python
result = subprocess.run(cmd, check=True, capture_output=True, text=False)
stdout = result.stdout.decode('utf-8', errors='replace')
```

**ä¼˜ç‚¹**: å®Œå…¨æ§åˆ¶è§£ç 
**ç¼ºç‚¹**: ä»£ç æ›´å¤æ‚

---

## ğŸ” æ•…éšœæ’é™¤

### å¦‚æœä»ç„¶å‡ºç°ç¼–ç é”™è¯¯

**å¯èƒ½åŸå› **:
1. Python ç‰ˆæœ¬è¿‡ä½ï¼ˆ< 3.6ï¼‰
2. subprocess æ¨¡å—å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**:
```python
# é™çº§åˆ° bytes æ¨¡å¼
result = subprocess.run(cmd, check=True, capture_output=True, text=False)
try:
    stdout = result.stdout.decode('utf-8', errors='replace')
except:
    stdout = ""
```

### å¦‚æœ ffmpeg è¾“å‡ºä¹±ç 

**åŸå› **: ç‰¹æ®Šå­—ç¬¦è¢«æ›¿æ¢ä¸º ï¿½

**å½±å“**: æ— å½±å“ï¼ˆåªæ˜¯æ—¥å¿—æ˜¾ç¤ºï¼Œä¸å½±å“åŠŸèƒ½ï¼‰

**è§£å†³**: å¯ä»¥å¿½ç•¥ï¼Œæˆ–ä½¿ç”¨ `errors='ignore'` å®Œå…¨éšè—

---

## ğŸ“Š ä¿®æ”¹æ€»ç»“

### ä¿®æ”¹èŒƒå›´

- **æ–‡ä»¶æ•°**: 1 ä¸ª
- **ä¿®æ”¹è¡Œæ•°**: 7 è¡Œï¼ˆæ·»åŠ å‚æ•°ï¼‰
- **é£é™©ç­‰çº§**: æä½ â­â­â­â­â­
- **å½±å“èŒƒå›´**: ä»…æ—¥å¿—è¾“å‡º

### ä¿®æ”¹ç±»å‹

- âœ… **éä¾µå…¥å¼**: ä¸æ”¹å˜ä»»ä½•ä¸šåŠ¡é€»è¾‘
- âœ… **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… **å®‰å…¨**: æ·»åŠ é”™è¯¯å®¹å¿æœºåˆ¶

---

## ğŸ‰ å®Œæˆæ¸…å•

### InfiniteTalk æ‰€æœ‰åŠŸèƒ½

1. âœ… Wav2Vec æ¨¡å‹åŠ è½½ï¼ˆå¯é€‰ç²¾åº¦/è®¾å¤‡ï¼‰
2. âœ… éŸ³é¢‘æ–‡ä»¶åŠ è½½ï¼ˆsoundfileï¼Œæ­£ç¡®æ ¼å¼ï¼‰
3. âœ… éŸ³é¢‘åµŒå…¥ç”Ÿæˆï¼ˆå˜´å‹åŒæ­¥ï¼‰
4. âœ… è§†é¢‘å¸§ç”Ÿæˆï¼ˆå˜´å‹æ­£ç¡®ï¼‰
5. âœ… è§†é¢‘ä¿å­˜ï¼ˆcv2 åŒé‡å¤‡ä»½ï¼‰
6. âœ… éŸ³é¢‘åˆå¹¶ï¼ˆffmpegï¼‰
7. âœ… **ç¼–ç é”™è¯¯ä¿®å¤** â† æ–°å®Œæˆï¼
8. âœ… è¾“å‡ºå¸¦å£°éŸ³çš„è§†é¢‘

### æ‰€æœ‰é—®é¢˜å·²è§£å†³

1. âœ… éŸ³é¢‘æ ¼å¼é—®é¢˜ï¼ˆbatch ç»´åº¦ï¼‰
2. âœ… è§†é¢‘ä¿å­˜é—®é¢˜ï¼ˆimageio åç«¯ï¼‰
3. âœ… éŸ³é¢‘åˆå¹¶é—®é¢˜ï¼ˆffmpeg é›†æˆï¼‰
4. âœ… **ç¼–ç é”™è¯¯é—®é¢˜ï¼ˆUTF-8 è§£ç ï¼‰** â† æ–°è§£å†³ï¼

---

## ğŸ’¡ æœ€ä½³å®è·µ

### subprocess è°ƒç”¨å»ºè®®

**æ¨èå†™æ³•**:
```python
result = subprocess.run(
    cmd,
    check=True,           # è‡ªåŠ¨æ£€æŸ¥è¿”å›ç 
    capture_output=True,  # æ•è·è¾“å‡º
    text=True,            # æ–‡æœ¬æ¨¡å¼
    encoding='utf-8',     # æ˜ç¡®æŒ‡å®šç¼–ç 
    errors='replace'      # é”™è¯¯å®¹å¿
)
```

**é¿å…å†™æ³•**:
```python
# ä¸æ¨èï¼šä¾èµ–ç³»ç»Ÿé»˜è®¤ç¼–ç 
result = subprocess.run(cmd, check=True, capture_output=True, text=True)
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### æ­£å¸¸ä½¿ç”¨æµç¨‹

1. å¯åŠ¨åº”ç”¨
2. é€‰æ‹© InfiniteTalk æ¨¡å¼
3. ä¸Šä¼ å›¾ç‰‡å’ŒéŸ³é¢‘
4. ç”Ÿæˆè§†é¢‘
5. **äº«å—å¹²å‡€çš„æ§åˆ¶å°è¾“å‡º** âœ¨

### é¢„æœŸä½“éªŒ

**æ§åˆ¶å°è¾“å‡º**:
```
[INFO] InfiniteTalk mode with audio detected
[INFO] Saving temporary video (no audio) using cv2...
[INFO] Temporary video (no audio) saved: ...
[INFO] Merging audio with video using ffmpeg...
[SUCCESS] Video with audio saved to: infinitetalk_xxx.mp4
[INFO] Temporary video deleted
```

**æ— å¼‚å¸¸ï¼Œæ— é”™è¯¯ï¼Œå®Œç¾ï¼** ğŸŠ

---

## æ€»ç»“

**é—®é¢˜**: ffmpeg è¾“å‡º UTF-8 ç¼–ç ï¼ŒPython ç”¨ GBK è§£ç å¤±è´¥

**è§£å†³**: æŒ‡å®š UTF-8 ç¼–ç  + é”™è¯¯å®¹å¿

**ä¿®æ”¹**: ä»… 7 è¡Œä»£ç ï¼Œæ·»åŠ  2 ä¸ªå‚æ•°

**å½±å“**: é›¶å½±å“ï¼ˆå®Œå…¨ä¸æ”¹å˜åŠŸèƒ½ï¼‰

**æ•ˆæœ**: æ§åˆ¶å°è¾“å‡ºå¹²å‡€ï¼Œæ— å¼‚å¸¸ä¿¡æ¯

**çŠ¶æ€**: âœ… å®Œç¾ä¿®å¤ï¼

---

**InfiniteTalk æ‰€æœ‰åŠŸèƒ½ç°å·²å®Œå…¨ç¨³å®šå¯ç”¨ï¼** ğŸ‰ğŸŠâœ¨
