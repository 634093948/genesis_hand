# 🧪 第一阶段测试指南 - 宽高比锁定功能

## ✅ 已完成的修改

### 修改内容
1. ✅ 添加宽高比锁定复选框
2. ✅ 添加宽高比自动计算功能
3. ✅ 优化 UI 标签和提示信息

### 修改文件
- `genesis/apps/wanvideo_gradio_app.py`

### 备份文件
- `genesis/apps/wanvideo_gradio_app.py.backup`

---

## 🚀 启动测试

### 步骤 1: 启动应用

```bash
cd e:\liliyuanshangmie\genesis_hand
python genesis/apps/wanvideo_gradio_app.py
```

### 步骤 2: 打开浏览器

应用启动后会显示类似：
```
Running on local URL:  http://127.0.0.1:7860
```

在浏览器中打开这个 URL。

### 步骤 3: 进入测试页面

点击 "🖼️ Image to Video" 标签页

---

## 📋 测试清单

### 测试 1: UI 显示检查 ✓

**检查项目**:
- [ ] "📐 视频尺寸" 标题显示正常
- [ ] 宽度滑块显示 "宽度 (Width)" 和提示 "必须是16的倍数"
- [ ] 高度滑块显示 "高度 (Height)" 和提示 "必须是16的倍数"
- [ ] "🔒 锁定宽高比" 复选框显示正常
- [ ] 复选框默认已勾选
- [ ] 帧数和 FPS 滑块显示正常

**预期结果**:
```
┌─────────────────────────────────────────┐
│ 📐 视频尺寸                             │
├─────────────────────────────────────────┤
│ 宽度 (Width): [====|====] 832          │
│ 必须是16的倍数                          │
│                                         │
│ 高度 (Height): [====|====] 480         │
│ 必须是16的倍数                          │
│                                         │
│ [✓] 🔒 锁定宽高比                       │
│ 保持 832:480 比例                       │
├─────────────────────────────────────────┤
│ 帧数 (Frames): [====|====] 81          │
│ 必须是4的倍数                           │
│                                         │
│ 帧率 (FPS): [====|====] 25             │
│ InfiniteTalk推荐25                      │
└─────────────────────────────────────────┘
```

---

### 测试 2: 宽高比锁定功能 ✓

#### 测试 2.1: 调整宽度

**操作步骤**:
1. 确认 "🔒 锁定宽高比" 已勾选
2. 将宽度从 832 调整到 1024

**预期结果**:
- 高度自动从 480 调整到 592
- 比例保持 1.733 (1024/592 ≈ 1.733)
- 高度是 16 的倍数

**验证公式**:
```
新高度 = 1024 / (832/480) = 1024 / 1.733 = 591.xx
四舍五入到16倍数 = 592
```

#### 测试 2.2: 调整高度

**操作步骤**:
1. 确认 "🔒 锁定宽高比" 已勾选
2. 将高度从 480 调整到 720

**预期结果**:
- 宽度自动从 832 调整到 1248
- 比例保持 1.733 (1248/720 ≈ 1.733)
- 宽度是 16 的倍数

**验证公式**:
```
新宽度 = 720 * (832/480) = 720 * 1.733 = 1247.xx
四舍五入到16倍数 = 1248
```

#### 测试 2.3: 多次调整

**操作步骤**:
1. 宽度: 832 → 1024 → 1280 → 640
2. 观察高度变化

**预期结果**:
| 宽度 | 预期高度 | 比例 |
|------|----------|------|
| 832  | 480      | 1.733 |
| 1024 | 592      | 1.730 |
| 1280 | 736      | 1.739 |
| 640  | 368      | 1.739 |

---

### 测试 3: 解锁功能 ✓

#### 测试 3.1: 解锁后调整宽度

**操作步骤**:
1. 取消勾选 "🔒 锁定宽高比"
2. 将宽度从 832 调整到 1024

**预期结果**:
- 高度保持 480 不变
- 宽度变为 1024
- 比例变为 2.133 (1024/480)

#### 测试 3.2: 解锁后调整高度

**操作步骤**:
1. 确认 "🔒 锁定宽高比" 未勾选
2. 将高度从 480 调整到 720

**预期结果**:
- 宽度保持不变
- 高度变为 720
- 可以自由设置任意比例

---

### 测试 4: 边界情况 ✓

#### 测试 4.1: 最大值测试

**操作步骤**:
1. 勾选 "🔒 锁定宽高比"
2. 将宽度调到最大 2048

**预期结果**:
- 高度自动调整到 1184
- 高度不超过 2048
- 高度是 16 的倍数

#### 测试 4.2: 最小值测试

**操作步骤**:
1. 勾选 "🔒 锁定宽高比"
2. 将高度调到最小 64

**预期结果**:
- 宽度自动调整到 112
- 宽度不小于 64
- 宽度是 16 的倍数

#### 测试 4.3: 极限比例测试

**操作步骤**:
1. 解锁宽高比
2. 宽度设为 2048，高度设为 64
3. 重新锁定宽高比
4. 调整宽度

**预期结果**:
- 锁定后按新的比例计算
- 不会崩溃或出错

---

### 测试 5: 功能兼容性 ✓

#### 测试 5.1: InfiniteTalk 模式

**操作步骤**:
1. 选择 InfiniteTalk 模式
2. 上传图片和音频
3. 使用锁定的宽高比（832x480）
4. 生成视频

**预期结果**:
- 视频正常生成
- 分辨率为 832x480
- 音频嵌入正常
- 嘴型同步正常

#### 测试 5.2: WanAnimate 模式

**操作步骤**:
1. 选择 WanAnimate 模式
2. 上传图片
3. 调整宽高比（如 1024x592）
4. 生成视频

**预期结果**:
- 视频正常生成
- 分辨率为 1024x592
- 动画效果正常

#### 测试 5.3: Standard I2V 模式

**操作步骤**:
1. 选择 Standard I2V 模式
2. 上传图片
3. 使用自定义宽高比
4. 生成视频

**预期结果**:
- 视频正常生成
- 分辨率正确
- 无错误

---

## 🐛 常见问题排查

### 问题 1: 应用启动失败

**症状**:
```
ModuleNotFoundError: No module named 'xxx'
```

**解决**:
```bash
# 检查依赖
pip list | grep gradio

# 重新安装
pip install gradio
```

### 问题 2: 宽高比不自动调整

**检查**:
1. 复选框是否勾选？
2. 浏览器控制台是否有错误？
3. 事件绑定是否正确？

**调试**:
```python
# 在函数中添加 print
def on_width_change(width, height, lock):
    print(f"[DEBUG] Width changed: {width}, Lock: {lock}")
    # ...
```

### 问题 3: 计算结果不正确

**检查**:
1. 宽高比是否正确（832/480 = 1.733）
2. 四舍五入是否正确
3. 范围限制是否生效

**验证**:
```python
# 手动计算
aspect_ratio = 832 / 480  # 1.7333...
new_height = 1024 / aspect_ratio  # 591.xx
rounded = round(new_height / 16) * 16  # 592
```

---

## ✅ 测试通过标准

### 必须通过的测试

- [ ] UI 显示正常
- [ ] 锁定状态下宽度调整，高度自动调整
- [ ] 锁定状态下高度调整，宽度自动调整
- [ ] 解锁状态下可以自由调整
- [ ] 边界值处理正确
- [ ] InfiniteTalk 模式正常生成
- [ ] WanAnimate 模式正常生成
- [ ] Standard I2V 模式正常生成

### 可选测试

- [ ] 多次切换锁定/解锁
- [ ] 极限比例测试
- [ ] 性能测试（调整速度）

---

## 📊 测试结果记录

### 测试环境

- **操作系统**: Windows
- **Python 版本**: 3.13
- **Gradio 版本**: _____
- **测试时间**: _____

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| UI 显示 | ⬜ 通过 / ⬜ 失败 | |
| 宽度调整 | ⬜ 通过 / ⬜ 失败 | |
| 高度调整 | ⬜ 通过 / ⬜ 失败 | |
| 解锁功能 | ⬜ 通过 / ⬜ 失败 | |
| 边界测试 | ⬜ 通过 / ⬜ 失败 | |
| InfiniteTalk | ⬜ 通过 / ⬜ 失败 | |
| WanAnimate | ⬜ 通过 / ⬜ 失败 | |
| Standard I2V | ⬜ 通过 / ⬜ 失败 | |

### 发现的问题

1. _____
2. _____
3. _____

---

## 🎯 下一步

### 如果测试通过 ✅

继续第二阶段优化：
- 参数分类重组
- 添加更多 emoji 图标
- 优化参数提示信息

### 如果测试失败 ❌

1. 记录错误信息
2. 检查代码修改
3. 必要时回滚到备份
4. 修复问题后重新测试

---

## 🔄 回滚方法

如果需要回滚：

```bash
# Windows PowerShell
Copy-Item "genesis/apps/wanvideo_gradio_app.py.backup" -Destination "genesis/apps/wanvideo_gradio_app.py" -Force

# 重新启动应用
python genesis/apps/wanvideo_gradio_app.py
```

---

**准备好开始测试了吗？** 🚀

完成测试后，告诉我结果，我们可以继续下一阶段的优化！
