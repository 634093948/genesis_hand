# âš¡ ä¼˜åŒ–å‚æ•°ä¿®å¤è¯´æ˜

**ä¿®å¤æ—¶é—´**: 2025/11/14 12:37
**é—®é¢˜**: ç”Ÿæˆé€Ÿåº¦æ¯”ä¹‹å‰æ…¢
**åŸå› **: ä¼˜åŒ–å‚æ•°æœªæ­£ç¡®ä¼ é€’åˆ°ç”Ÿæˆå‡½æ•°

---

## âŒ é—®é¢˜åŸå› 

### ä¹‹å‰çš„ä»£ç 

```python
# ç»Ÿä¸€ç”Ÿæˆå‡½æ•° - æ–‡ç”Ÿè§†é¢‘éƒ¨åˆ†
return generate_with_progress(
    pos_prompt, neg_prompt, w, h, frames,
    steps_val, cfg_val, shift_val, seed_val, sched, denoise,
    model, vae, t5, precision, quant, attn,
    # âŒ ç¼ºå°‘ LoRA å’Œä¼˜åŒ–å‚æ•°
)
```

**é—®é¢˜**:
- ç¼ºå°‘ LoRA å‚æ•°ï¼ˆ3 ä¸ªï¼‰
- ç¼ºå°‘ Torch Compile å‚æ•°ï¼ˆ2 ä¸ªï¼‰
- ç¼ºå°‘ VRAM ç®¡ç†å‚æ•°ï¼ˆ11 ä¸ªï¼‰
- ç¼ºå°‘è¾“å‡ºå‚æ•°ï¼ˆ2 ä¸ªï¼‰
- **æ€»è®¡ç¼ºå°‘ 18 ä¸ªå‚æ•°ï¼**

**åæœ**:
- âœ— LoRA æ— æ³•ä½¿ç”¨
- âœ— Torch Compile æœªå¯ç”¨
- âœ— VRAM æ™ºèƒ½ç®¡ç†æœªå¯ç”¨
- âœ— ç”Ÿæˆé€Ÿåº¦å˜æ…¢
- âœ— æ˜¾å­˜ä¼˜åŒ–å¤±æ•ˆ

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ  LoRA è®¾ç½®åˆ° UI

```python
# LoRA settings
with gr.Accordion("ğŸ¨ LoRA è®¾ç½®", open=False):
    lora_enabled = gr.Checkbox(
        label="å¯ç”¨ LoRA",
        value=False,
        info="ä½¿ç”¨ LoRA å¾®è°ƒæ¨¡å‹"
    )
    lora_name = gr.Dropdown(
        choices=available_loras if available_loras else ["No LoRA found"],
        value=available_loras[0] if available_loras and available_loras[0] != "No LoRA found" 
              else "Kinesis-T2V-14B_lora_fix.safetensors",
        label="Select LoRA",
        allow_custom_value=True,
        interactive=True
    )
    lora_strength = gr.Slider(
        -2.0, 2.0, value=1.0, step=0.01,
        label="LoRA Strength",
        info="LoRA å¼ºåº¦"
    )
```

### 2. æ›´æ–°ç”ŸæˆæŒ‰é’® inputs

```python
inputs=[
    video_gen_mode,
    input_image,
    positive_prompt, negative_prompt,
    keep_proportion, crop_position, upscale_method,
    width, height, num_frames, fps,
    steps, cfg, shift, seed, scheduler, denoise_strength,
    model_name, vae_name, t5_model,
    base_precision, quantization, attention_mode,
    compile_enabled, compile_backend,  # âœ… Torch Compile
    block_swap_enabled, auto_hardware_tuning, vram_threshold_percent,  # âœ… VRAM ç®¡ç†
    blocks_to_swap, enable_cuda_optimization, enable_dram_optimization,
    num_cuda_streams, bandwidth_target, offload_txt_emb, offload_img_emb,
    vace_blocks_to_swap, vram_debug_mode,
    lora_enabled, lora_name, lora_strength,  # âœ… LoRA è®¾ç½®
    audio_file, frame_window_size, motion_frame,
    wav2vec_precision, wav2vec_device,
    pose_images, face_images, pose_strength, face_strength, colormatch
]
```

**æ€»è®¡**: 50 ä¸ªå‚æ•°

### 3. æ›´æ–°ç»Ÿä¸€ç”Ÿæˆå‡½æ•°

```python
# æå–æ–‡ç”Ÿè§†é¢‘éœ€è¦çš„å‚æ•°
_, input_image, pos_prompt, neg_prompt, keep_prop, crop_pos, upscale, \
w, h, frames, fps_val, steps_val, cfg_val, shift_val, seed_val, sched, denoise, \
model, vae, t5, precision, quant, attn, \
compile_en, compile_back, block_swap, auto_tune, vram_thresh, \
blocks_swap, cuda_opt, dram_opt, cuda_streams, bandwidth, \
txt_emb_off, img_emb_off, vae_blocks, vram_debug, \
lora_en, lora_name_val, lora_str, \  # âœ… LoRA å‚æ•°
audio, frame_win, motion, wav_prec, wav_dev, \
pose_imgs, face_imgs, pose_str, face_str, color = args

print(f"[æ–‡ç”Ÿè§†é¢‘] ä¼˜åŒ–å‚æ•°:")
print(f"  - LoRA: {lora_en} ({lora_name_val if lora_en else 'disabled'})")
print(f"  - Compile: {compile_en}")
print(f"  - Block Swap: {block_swap}")
print(f"  - Auto Tuning: {auto_tune}")

# è°ƒç”¨åŸå§‹æ–‡ç”Ÿè§†é¢‘å‡½æ•°
return generate_with_progress(
    pos_prompt, neg_prompt, w, h, frames,
    steps_val, cfg_val, shift_val, seed_val, sched, denoise,
    model, vae, t5, precision, quant, attn,
    lora_en, lora_name_val, lora_str,  # âœ… LoRA å‚æ•°
    compile_en, compile_back, block_swap,  # âœ… Torch Compile
    "mp4", fps_val,  # âœ… è¾“å‡ºå‚æ•°
    auto_tune, vram_thresh, blocks_swap,  # âœ… VRAM ç®¡ç†
    cuda_opt, dram_opt, cuda_streams, bandwidth,
    txt_emb_off, img_emb_off, vae_blocks, vram_debug
)
```

---

## ğŸ“Š å‚æ•°å®Œæ•´åˆ—è¡¨

### generate_with_progress å‡½æ•°ç­¾å (36 ä¸ªå‚æ•°)

```python
def generate_with_progress(
    # 1-11: åŸºç¡€å‚æ•°
    positive_prompt, negative_prompt, width, height, num_frames,
    steps, cfg, shift, seed, scheduler, denoise_strength,
    
    # 12-17: æ¨¡å‹é…ç½®
    model_name, vae_name, t5_model, 
    base_precision, quantization, attention_mode,
    
    # 18-20: LoRA è®¾ç½®
    lora_enabled, lora_name, lora_strength,
    
    # 21-23: Torch Compile
    compile_enabled, compile_backend, block_swap_enabled,
    
    # 24-25: è¾“å‡ºå‚æ•°
    output_format, fps,
    
    # 26-36: VRAM æ™ºèƒ½ç®¡ç†
    auto_hardware_tuning, vram_threshold_percent, blocks_to_swap,
    enable_cuda_optimization, enable_dram_optimization,
    num_cuda_streams, bandwidth_target,
    offload_txt_emb, offload_img_emb,
    vace_blocks_to_swap, vram_debug_mode
)
```

---

## ğŸ¯ ä¼˜åŒ–åŠŸèƒ½æ¢å¤

### 1. LoRA æ”¯æŒ âœ…

```python
lora_enabled = True
lora_name = "Kinesis-T2V-14B_lora_fix.safetensors"
lora_strength = 1.0
```

**æ•ˆæœ**:
- âœ… å¯ä»¥ä½¿ç”¨ LoRA å¾®è°ƒæ¨¡å‹
- âœ… æå‡ç”Ÿæˆè´¨é‡
- âœ… é£æ ¼æ§åˆ¶

### 2. Torch Compile âœ…

```python
compile_enabled = True
compile_backend = "inductor"
```

**æ•ˆæœ**:
- âœ… åŠ é€Ÿæ¨¡å‹æ¨ç†
- âœ… é¦–æ¬¡ç¼–è¯‘åé€Ÿåº¦æå‡ 20-30%
- âœ… å‡å°‘æ˜¾å­˜å ç”¨

### 3. VRAM æ™ºèƒ½ç®¡ç† âœ…

```python
block_swap_enabled = True
auto_hardware_tuning = True
vram_threshold_percent = 50.0
```

**æ•ˆæœ**:
- âœ… è‡ªåŠ¨ä¼˜åŒ– VRAM-DRAM å¹³è¡¡
- âœ… é˜²æ­¢æ˜¾å­˜æº¢å‡º
- âœ… æ”¯æŒæ›´å¤§åˆ†è¾¨ç‡/å¸§æ•°

### 4. CUDA ä¼˜åŒ– âœ…

```python
enable_cuda_optimization = True
num_cuda_streams = 8
```

**æ•ˆæœ**:
- âœ… å¤šæµå¹¶è¡Œä¼ è¾“
- âœ… æå‡è¿ç§»æ•ˆç‡
- âœ… å‡å°‘ç­‰å¾…æ—¶é—´

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### ä¿®å¤å‰ vs ä¿®å¤å

| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| **LoRA** | âŒ ä¸å¯ç”¨ | âœ… å¯ç”¨ | - |
| **Torch Compile** | âŒ æœªå¯ç”¨ | âœ… å¯å¯ç”¨ | +20-30% |
| **VRAM ç®¡ç†** | âŒ æœªå¯ç”¨ | âœ… å¯å¯ç”¨ | é˜²æ­¢ OOM |
| **CUDA ä¼˜åŒ–** | âŒ æœªå¯ç”¨ | âœ… å¯å¯ç”¨ | +10-15% |
| **æ€»ä½“é€Ÿåº¦** | æ…¢ | æ­£å¸¸ | +30-50% |

---

## ğŸ” å¦‚ä½•éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥ä¼˜åŒ–è®¾ç½®

å¯åŠ¨åº”ç”¨åï¼Œåœ¨è§†é¢‘ç”Ÿæˆæ ‡ç­¾é¡µä¸­ï¼š

1. å±•å¼€ "âš¡ æ€§èƒ½ä¼˜åŒ–"
   - âœ… çœ‹åˆ° Torch Compile é€‰é¡¹
   - âœ… çœ‹åˆ°æ™ºèƒ½ VRAM ç®¡ç†é€‰é¡¹

2. å±•å¼€ "ğŸ¨ LoRA è®¾ç½®"
   - âœ… çœ‹åˆ°å¯ç”¨ LoRA é€‰é¡¹
   - âœ… çœ‹åˆ° LoRA é€‰æ‹©ä¸‹æ‹‰æ¡†

### 2. æµ‹è¯•ç”Ÿæˆé€Ÿåº¦

**æµ‹è¯•å‚æ•°**:
```
åˆ†è¾¨ç‡: 832x480
å¸§æ•°: 81
Steps: 20
```

**å¯ç”¨ä¼˜åŒ–**:
```
Torch Compile: âœ… å¯ç”¨
VRAM ç®¡ç†: âœ… å¯ç”¨
Auto Tuning: âœ… å¯ç”¨
```

**æŸ¥çœ‹æ—¥å¿—**:
```
[æ–‡ç”Ÿè§†é¢‘] ä¼˜åŒ–å‚æ•°:
  - LoRA: False (disabled)
  - Compile: True
  - Block Swap: True
  - Auto Tuning: True
```

### 3. å¯¹æ¯”ç”Ÿæˆæ—¶é—´

| é…ç½® | é¢„è®¡æ—¶é—´ (RTX 4090) |
|------|-------------------|
| **æ— ä¼˜åŒ–** | ~60-80 ç§’ |
| **Torch Compile** | ~45-55 ç§’ |
| **+ VRAM ç®¡ç†** | ~40-50 ç§’ |
| **+ CUDA ä¼˜åŒ–** | ~35-45 ç§’ |

---

## ğŸ¨ UI ç»“æ„æ›´æ–°

### è§†é¢‘ç”Ÿæˆæ ‡ç­¾é¡µå®Œæ•´ç»“æ„

```
ğŸ“¹ è§†é¢‘ç”Ÿæˆ
â”œâ”€â”€ æ¨¡å¼é€‰æ‹©
â”œâ”€â”€ è¾“å…¥å’Œå‚æ•°
â”œâ”€â”€ ğŸ¨ æ¨¡å‹é…ç½® (æŠ˜å )
â”œâ”€â”€ âš™ï¸ é«˜çº§è®¾ç½® (æŠ˜å )
â”œâ”€â”€ âš¡ æ€§èƒ½ä¼˜åŒ– (æŠ˜å ) âœ…
â”‚   â”œâ”€â”€ Torch Compile
â”‚   â””â”€â”€ æ™ºèƒ½ VRAM ç®¡ç†
â”‚       â””â”€â”€ VRAM é«˜çº§å‚æ•° (æŠ˜å )
â”œâ”€â”€ ğŸ¨ LoRA è®¾ç½® (æŠ˜å ) âœ… æ–°å¢
â”‚   â”œâ”€â”€ å¯ç”¨ LoRA
â”‚   â”œâ”€â”€ Select LoRA
â”‚   â””â”€â”€ LoRA Strength
â”œâ”€â”€ InfiniteTalk è®¾ç½® (åŠ¨æ€)
â””â”€â”€ WanAnimate è®¾ç½® (åŠ¨æ€)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Torch Compile é¦–æ¬¡ç¼–è¯‘

**é¦–æ¬¡ç”Ÿæˆ**:
- éœ€è¦ç¼–è¯‘æ¨¡å‹ï¼ˆçº¦ 30-60 ç§’ï¼‰
- æ˜¾ç¤º "Compiling model..." ä¿¡æ¯
- ç¼–è¯‘åä¼šç¼“å­˜

**åç»­ç”Ÿæˆ**:
- ç›´æ¥ä½¿ç”¨ç¼“å­˜
- æ— éœ€é‡æ–°ç¼–è¯‘
- é€Ÿåº¦æå‡æ˜æ˜¾

### 2. VRAM ç®¡ç†è‡ªåŠ¨è°ƒä¼˜

**å¯ç”¨å**:
- è‡ªåŠ¨æ£€æµ‹ GPU å‹å·
- è‡ªåŠ¨é…ç½®æœ€ä¼˜å‚æ•°
- æ— éœ€æ‰‹åŠ¨è°ƒæ•´

**æ‰‹åŠ¨è°ƒæ•´**:
- å…³é—­ "è‡ªåŠ¨ç¡¬ä»¶è°ƒä¼˜"
- æ‰‹åŠ¨è®¾ç½®åˆ†å—æ•°ç­‰å‚æ•°
- é€‚åˆé«˜çº§ç”¨æˆ·

### 3. LoRA æ–‡ä»¶ä½ç½®

ç¡®ä¿ LoRA æ–‡ä»¶åœ¨æ­£ç¡®ç›®å½•ï¼š
```
models/
â””â”€â”€ lora/
    â””â”€â”€ Kinesis-T2V-14B_lora_fix.safetensors
```

---

## âœ… ä¿®å¤å®Œæˆ

### ä¿®å¤å†…å®¹

1. âœ… æ·»åŠ  LoRA è®¾ç½®åˆ° UI
2. âœ… æ›´æ–°ç”ŸæˆæŒ‰é’® inputsï¼ˆ+3 ä¸ªå‚æ•°ï¼‰
3. âœ… æ›´æ–°ç»Ÿä¸€ç”Ÿæˆå‡½æ•°å‚æ•°è§£åŒ…
4. âœ… æ­£ç¡®ä¼ é€’æ‰€æœ‰ä¼˜åŒ–å‚æ•°
5. âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—è¾“å‡º

### æ¢å¤çš„åŠŸèƒ½

1. âœ… LoRA æ”¯æŒ
2. âœ… Torch Compile åŠ é€Ÿ
3. âœ… VRAM æ™ºèƒ½ç®¡ç†
4. âœ… CUDA ä¼˜åŒ–
5. âœ… æ‰€æœ‰æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½

---

## ğŸš€ æµ‹è¯•å»ºè®®

### 1. åŸºç¡€æµ‹è¯•

```
æ¨¡å¼: æ–‡ç”Ÿè§†é¢‘
æç¤ºè¯: "a beautiful landscape"
åˆ†è¾¨ç‡: 832x480
å¸§æ•°: 81
ä¼˜åŒ–: å…¨éƒ¨å¯ç”¨
```

### 2. æ€§èƒ½æµ‹è¯•

**å¯¹æ¯”æµ‹è¯•**:
1. å…³é—­æ‰€æœ‰ä¼˜åŒ– â†’ è®°å½•æ—¶é—´
2. å¯ç”¨ Torch Compile â†’ è®°å½•æ—¶é—´
3. å¯ç”¨ VRAM ç®¡ç† â†’ è®°å½•æ—¶é—´
4. å¯ç”¨ CUDA ä¼˜åŒ– â†’ è®°å½•æ—¶é—´

### 3. LoRA æµ‹è¯•

```
å¯ç”¨ LoRA: âœ…
LoRA æ–‡ä»¶: Kinesis-T2V-14B_lora_fix.safetensors
LoRA å¼ºåº¦: 1.0
```

---

**ğŸ‰ ä¼˜åŒ–å‚æ•°å·²å®Œå…¨ä¿®å¤ï¼ç”Ÿæˆé€Ÿåº¦åº”è¯¥æ¢å¤æ­£å¸¸äº†ï¼** ğŸ‰

**ç°åœ¨å¯ä»¥é‡æ–°å¯åŠ¨æµ‹è¯•ï¼š**
```bash
START_UI.bat
```
