# âœ… éŸ³é¢‘æ ¼å¼ä¿®å¤å®Œæˆ

## é—®é¢˜æè¿°

```
IndexError: tuple index out of range
File "pyloudnorm/util.py", line 32, in valid_audio
    if data.shape[0] < block_size * rate:
```

---

## ğŸ” é—®é¢˜æ ¹æº

### éŸ³é¢‘ç»´åº¦é¡ºåºé”™è¯¯

**é”™è¯¯çš„æ ¼å¼** (ä¹‹å‰):
```python
waveform.shape = (2, 160752)  # (channels, samples)
```

**æ­£ç¡®çš„æ ¼å¼** (ComfyUI AUDIO):
```python
waveform.shape = (1, 2, 160752)  # (batch, channels, samples)
```

### ä¸ºä»€ä¹ˆä¼šå‡ºé”™ï¼Ÿ

1. **æˆ‘ä»¬çš„ä»£ç **è¿”å› `(channels, samples)`
2. **MultiTalkWav2VecEmbeds** æœŸæœ› `(batch, channels, samples)`
3. èŠ‚ç‚¹ä»£ç ä¸­æœ‰ `audio_input[0][0]` æ¥æå–å•å£°é“æ•°æ®
4. ä½†æˆ‘ä»¬çš„æ ¼å¼ç¼ºå°‘ batch ç»´åº¦ï¼Œå¯¼è‡´ç´¢å¼•é”™è¯¯

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹ä½ç½®

**æ–‡ä»¶**: `genesis/apps/wanvideo_gradio_app.py`
**å‡½æ•°**: `load_audio_with_soundfile` (ç¬¬ 115-149 è¡Œ)

### ä¿®æ”¹å†…å®¹

#### ä¿®æ”¹å‰
```python
# ç¡®ä¿æ˜¯ (channels, samples) æ ¼å¼
if waveform.dim() == 1:
    # å•å£°é“: (samples,) -> (1, samples)
    waveform = waveform.unsqueeze(0)
else:
    # ç«‹ä½“å£°: (samples, channels) -> (channels, samples)
    waveform = waveform.T
```

#### ä¿®æ”¹å
```python
# ç¡®ä¿æ˜¯ (batch, channels, samples) æ ¼å¼ï¼Œä¸ ComfyUI ä¸€è‡´
if waveform.dim() == 1:
    # å•å£°é“: (samples,) -> (1, 1, samples)
    waveform = waveform.unsqueeze(0).unsqueeze(0)
else:
    # ç«‹ä½“å£°: (samples, channels) -> (1, channels, samples)
    # å…ˆè½¬ç½®ä¸º (channels, samples)ï¼Œå†æ·»åŠ  batch ç»´åº¦
    waveform = waveform.T.unsqueeze(0)
```

---

## ğŸ“Š æ•°æ®æµå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰

```
soundfile.read()
    â†“
(160752, 2)  # (samples, channels)
    â†“
torch.from_numpy()
    â†“
(160752, 2)
    â†“
.T (è½¬ç½®)
    â†“
(2, 160752)  # (channels, samples) â† ç¼ºå°‘ batch ç»´åº¦ï¼
    â†“
MultiTalkWav2VecEmbeds
    â†“
audio_input[0][0]  # âŒ IndexError!
```

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰

```
soundfile.read()
    â†“
(160752, 2)  # (samples, channels)
    â†“
torch.from_numpy()
    â†“
(160752, 2)
    â†“
.T.unsqueeze(0)
    â†“
(1, 2, 160752)  # (batch, channels, samples) âœ…
    â†“
MultiTalkWav2VecEmbeds
    â†“
audio_input[0][0]  # âœ… æ­£ç¡®æå–å•å£°é“
    â†“
(160752,)  # å•å£°é“æ•°æ®
    â†“
pyloudnorm.integrated_loudness()  # âœ… æ­£å¸¸å·¥ä½œ
```

---

## ğŸ¯ ComfyUI AUDIO æ ¼å¼æ ‡å‡†

### æ ¼å¼å®šä¹‰

```python
AUDIO = {
    "waveform": torch.Tensor,  # shape: (batch, channels, samples)
    "sample_rate": int
}
```

### ç¤ºä¾‹

**å•å£°é“éŸ³é¢‘**:
```python
{
    "waveform": torch.Size([1, 1, 160752]),  # (1, 1, samples)
    "sample_rate": 44100
}
```

**ç«‹ä½“å£°éŸ³é¢‘**:
```python
{
    "waveform": torch.Size([1, 2, 160752]),  # (1, 2, samples)
    "sample_rate": 44100
}
```

---

## ğŸ”§ MultiTalkWav2VecEmbeds å¤„ç†æµç¨‹

### èŠ‚ç‚¹å†…éƒ¨ä»£ç 

```python
# ç¬¬ 188-193 è¡Œ
audio_input = audio["waveform"]        # (1, 2, 160752)
sample_rate = audio["sample_rate"]     # 44100

# é‡é‡‡æ ·åˆ° 16kHz
if sample_rate != 16000:
    audio_input = torchaudio.functional.resample(audio_input, sample_rate, 16000)

# æå–å•å£°é“ (ç¬¬ä¸€ä¸ª batchï¼Œç¬¬ä¸€ä¸ª channel)
audio_input = audio_input[0][0]        # (160752,)
```

### ä¸ºä»€ä¹ˆéœ€è¦ `[0][0]`ï¼Ÿ

1. `[0]` - æå–ç¬¬ä¸€ä¸ª batch: `(1, 2, 160752)` â†’ `(2, 160752)`
2. `[0]` - æå–ç¬¬ä¸€ä¸ª channel: `(2, 160752)` â†’ `(160752,)`

ç»“æœï¼šå•å£°é“éŸ³é¢‘æ•°æ®ï¼Œå¯ä»¥ä¼ ç»™ `pyloudnorm`

---

## âœ… ä¿®å¤éªŒè¯

### é¢„æœŸæ—¥å¿—è¾“å‡º

```
[DEBUG] Audio loaded with soundfile: 44100Hz, shape=torch.Size([1, 2, 160752])
[DEBUG] Audio file loaded: sample_rate=44100, shape=torch.Size([1, 2, 160752])
[DEBUG] Creating audio embeds...
[INFO] Audio embeds created, actual frames: 81
```

### ä¸å†å‡ºç°çš„é”™è¯¯

```
âŒ [WARNING] Audio processing failed: tuple index out of range
```

---

## ğŸ‰ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ éŸ³é¢‘åŠ è½½å¤±è´¥
- âŒ é™çº§åˆ°é™éŸ³æ¨¡å¼
- âŒ è§†é¢‘æ²¡æœ‰å˜´å‹åŒæ­¥

### ä¿®å¤å
- âœ… éŸ³é¢‘åŠ è½½æˆåŠŸ
- âœ… éŸ³é¢‘åµŒå…¥ç”ŸæˆæˆåŠŸ
- âœ… è§†é¢‘å˜´å‹ä¸éŸ³é¢‘åŒæ­¥
- âœ… è§†é¢‘å¸¦å£°éŸ³ï¼ˆffmpeg åˆå¹¶ï¼‰

---

## ğŸ“‹ å®Œæ•´åŠŸèƒ½æ¸…å•

ç°åœ¨ InfiniteTalk çš„æ‰€æœ‰åŠŸèƒ½éƒ½å·²å®Œæˆï¼š

1. âœ… Wav2Vec æ¨¡å‹åŠ è½½ï¼ˆå¯é€‰ç²¾åº¦/è®¾å¤‡ï¼‰
2. âœ… éŸ³é¢‘æ–‡ä»¶åŠ è½½ï¼ˆsoundfileï¼Œæ”¯æŒ MP3/WAV/FLACï¼‰
3. âœ… éŸ³é¢‘æ ¼å¼è½¬æ¢ï¼ˆæ­£ç¡®çš„ batch/channels/samples é¡ºåºï¼‰
4. âœ… éŸ³é¢‘åµŒå…¥ç”Ÿæˆï¼ˆå˜´å‹åŒæ­¥ï¼‰
5. âœ… è§†é¢‘å¸§ç”Ÿæˆï¼ˆå˜´å‹æ­£ç¡®ï¼‰
6. âœ… è§†é¢‘éŸ³é¢‘åˆå¹¶ï¼ˆffmpegï¼‰
7. âœ… è¾“å‡ºå¸¦å£°éŸ³çš„è§†é¢‘

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

1. å¯åŠ¨åº”ç”¨
2. é€‰æ‹© InfiniteTalk æ¨¡å¼
3. ä¸Šä¼ å›¾ç‰‡
4. ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼ˆMP3/WAVï¼‰
5. ç‚¹å‡»ç”Ÿæˆ
6. æ£€æŸ¥æ—¥å¿—ï¼š
   ```
   [DEBUG] Audio loaded with soundfile: 44100Hz, shape=torch.Size([1, 2, 160752])
   [INFO] Audio embeds created, actual frames: 81
   [SUCCESS] Video with audio saved to: ...
   ```
7. æ’­æ”¾è§†é¢‘ï¼Œç¡®è®¤ï¼š
   - âœ… æœ‰ç”»é¢
   - âœ… æœ‰å£°éŸ³
   - âœ… å˜´å‹åŒæ­¥

---

## ğŸ’¡ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆæ˜¯ (batch, channels, samples)ï¼Ÿ

è¿™æ˜¯ PyTorch éŸ³é¢‘å¤„ç†çš„æ ‡å‡†æ ¼å¼ï¼š
- **batch**: æ‰¹å¤„ç†ç»´åº¦ï¼ˆé€šå¸¸ä¸º 1ï¼‰
- **channels**: å£°é“æ•°ï¼ˆ1=å•å£°é“ï¼Œ2=ç«‹ä½“å£°ï¼‰
- **samples**: é‡‡æ ·ç‚¹æ•°

### ä¸ºä»€ä¹ˆè¦è½¬ç½®ï¼Ÿ

soundfile è¿”å› `(samples, channels)`ï¼Œéœ€è¦è½¬ç½®ä¸º `(channels, samples)`ï¼Œå†æ·»åŠ  batch ç»´åº¦ã€‚

### å•å£°é“ vs ç«‹ä½“å£°

- **å•å£°é“**: `(samples,)` â†’ `(1, 1, samples)`
- **ç«‹ä½“å£°**: `(samples, 2)` â†’ `(1, 2, samples)`

---

## ğŸ” æ•…éšœæ’é™¤

### å¦‚æœä»ç„¶æŠ¥é”™

1. æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ ¼å¼
2. æ£€æŸ¥ soundfile æ˜¯å¦æ­£ç¡®å®‰è£…
3. æ£€æŸ¥æ—¥å¿—ä¸­çš„ shape æ˜¯å¦ä¸º `(1, channels, samples)`

### å¦‚æœéŸ³é¢‘è´¨é‡å·®

è°ƒæ•´ Wav2Vec å‚æ•°ï¼š
- ç²¾åº¦ï¼šfp16 â†’ fp32
- è®¾å¤‡ï¼šoffload_device â†’ main_device

---

## æ€»ç»“

**é—®é¢˜**: éŸ³é¢‘æ ¼å¼ç¼ºå°‘ batch ç»´åº¦
**åŸå› **: ä¸ ComfyUI AUDIO æ ¼å¼ä¸ä¸€è‡´
**è§£å†³**: æ·»åŠ  batch ç»´åº¦ï¼Œæ ¼å¼æ”¹ä¸º `(1, channels, samples)`
**ç»“æœ**: éŸ³é¢‘å¤„ç†æ­£å¸¸ï¼ŒInfiniteTalk å®Œå…¨å¯ç”¨

**æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆï¼** ğŸŠ
