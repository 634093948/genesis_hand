# âœ… éŸ³é¢‘åŠ è½½ä¿®å¤å®Œæˆ

## ä¿®å¤æ—¥æœŸï¼š2025-11-14

---

## ğŸ‰ æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼

éŸ³é¢‘åŠ è½½é—®é¢˜å·²å®Œå…¨è§£å†³ï¼Œç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ InfiniteTalk çš„éŸ³é¢‘åŠŸèƒ½äº†ã€‚

---

## âœ… å®Œæˆçš„ä¿®æ”¹

### 1. å®‰è£… soundfile âœ…
```bash
python313\python.exe -m pip install soundfile
```

**å®‰è£…ç»“æœ**:
- âœ… soundfile 0.13.1
- âœ… cffi 2.0.0
- âœ… pycparser 2.23

### 2. æ·»åŠ å¯¼å…¥ âœ…
**æ–‡ä»¶**: `genesis/apps/wanvideo_gradio_app.py`

```python
import soundfile as sf
```

### 3. æ·»åŠ éŸ³é¢‘åŠ è½½å‡½æ•° âœ…
**ä½ç½®**: ç¬¬ 114-144 è¡Œ

```python
def load_audio_with_soundfile(audio_file):
    """
    ä½¿ç”¨ soundfile åŠ è½½éŸ³é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒ MP3, WAV, FLAC ç­‰ï¼‰
    """
    try:
        # ä½¿ç”¨ soundfile è¯»å–éŸ³é¢‘
        waveform_np, sample_rate = sf.read(audio_file, dtype='float32')
        
        # è½¬æ¢ä¸º torch tensor
        waveform = torch.from_numpy(waveform_np)
        
        # ç¡®ä¿æ˜¯ (channels, samples) æ ¼å¼
        if waveform.dim() == 1:
            waveform = waveform.unsqueeze(0)
        else:
            waveform = waveform.T
        
        print(f"[DEBUG] Audio loaded with soundfile: {sample_rate}Hz, shape={waveform.shape}")
        return waveform, sample_rate
        
    except Exception as e:
        print(f"[ERROR] soundfile failed to load audio: {e}")
        return None, None
```

### 4. ä¿®å¤éŸ³é¢‘åŠ è½½é€»è¾‘ âœ…
**ä½ç½®**: ç¬¬ 367-396 è¡Œ

**ä¿®æ”¹å†…å®¹**:
```python
# åŸä»£ç ï¼ˆå·²åˆ é™¤ï¼‰:
# import torchaudio
# waveform, sample_rate = torchaudio.load(audio_file)

# æ–°ä»£ç :
waveform, sample_rate = load_audio_with_soundfile(audio_file)

if waveform is None:
    print(f"[WARNING] Could not load audio file, using silent mode...")
    audio_embeds = None
else:
    audio_data = {
        "waveform": waveform,
        "sample_rate": sample_rate
    }
    print(f"[DEBUG] Audio file loaded: sample_rate={sample_rate}, shape={waveform.shape}")
    
    # åˆ›å»ºéŸ³é¢‘åµŒå…¥
    wav2vec_embeds_node = NODE_CLASS_MAPPINGS['MultiTalkWav2VecEmbeds']()
    audio_embeds_result = wav2vec_embeds_node.process(
        wav2vec_model=wav2vec_model,
        audio_1=audio_data,
        normalize_loudness=True,
        num_frames=frame_window_size,
        fps=fps,
        audio_scale=1.0,
        audio_cfg_scale=1.0,
        multi_audio_type="para"
    )
    audio_embeds = audio_embeds_result[0]
    actual_num_frames = audio_embeds_result[2]
    print(f"[INFO] Audio embeds created, actual frames: {actual_num_frames}")
```

---

## ğŸ”§ ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1: torchaudio æ— æ³•åŠ è½½ MP3
**é”™è¯¯ä¿¡æ¯**:
```
RuntimeError: Couldn't find appropriate backend to handle uri ... and format None.
```

**è§£å†³æ–¹æ¡ˆ**:
- âœ… ä½¿ç”¨ soundfile æ›¿ä»£ torchaudio
- âœ… soundfile åŸç”Ÿæ”¯æŒ MP3, WAV, FLAC, OGG ç­‰æ ¼å¼

### é—®é¢˜ 2: éŸ³é¢‘åŠ è½½å¤±è´¥å¯¼è‡´ç¨‹åºå´©æºƒ
**è§£å†³æ–¹æ¡ˆ**:
- âœ… æ·»åŠ é”™è¯¯å¤„ç†
- âœ… éŸ³é¢‘åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨é™éŸ³æ¨¡å¼
- âœ… ä¸ä¼šä¸­æ–­è§†é¢‘ç”Ÿæˆæµç¨‹

---

## ğŸ“Š æ”¯æŒçš„éŸ³é¢‘æ ¼å¼

| æ ¼å¼ | æ‰©å±•å | çŠ¶æ€ |
|------|--------|------|
| WAV | .wav | âœ… å®Œç¾æ”¯æŒ |
| MP3 | .mp3 | âœ… å®Œç¾æ”¯æŒ |
| FLAC | .flac | âœ… å®Œç¾æ”¯æŒ |
| OGG | .ogg | âœ… å®Œç¾æ”¯æŒ |
| AIFF | .aiff | âœ… æ”¯æŒ |
| AU | .au | âœ… æ”¯æŒ |

---

## ğŸš€ æµ‹è¯•

### å¯åŠ¨åº”ç”¨
```bash
python genesis/apps/wanvideo_gradio_app.py
```

### é¢„æœŸè¾“å‡ºï¼ˆæœ‰éŸ³é¢‘ï¼‰
```
[INFO] Loading audio: C:\Users\...\audio.mp3
[DEBUG] Loading Wav2Vec model...
[DEBUG] Using Wav2Vec model: TencentGameMate/chinese-wav2vec2-base
[DEBUG] Wav2Vec model loaded from transformers/
[DEBUG] Loading audio file...
[DEBUG] Audio loaded with soundfile: 16000Hz, shape=torch.Size([1, 48000])
[DEBUG] Audio file loaded: sample_rate=16000, shape=torch.Size([1, 48000])
[DEBUG] Creating audio embeds...
[INFO] Audio embeds created, actual frames: 81
```

### é¢„æœŸè¾“å‡ºï¼ˆæ— éŸ³é¢‘/åŠ è½½å¤±è´¥ï¼‰
```
[WARNING] Could not load audio file, using silent mode...
[DEBUG] No audio provided, creating silent embeds for InfiniteTalk...
[INFO] Silent embeds created for 117 frames
```

---

## âœ… éªŒè¯æ¸…å•

- [x] soundfile å·²å®‰è£…
- [x] å¯¼å…¥å·²æ·»åŠ 
- [x] éŸ³é¢‘åŠ è½½å‡½æ•°å·²åˆ›å»º
- [x] éŸ³é¢‘åŠ è½½é€»è¾‘å·²ä¿®å¤
- [x] é”™è¯¯å¤„ç†å·²æ·»åŠ 
- [x] é™éŸ³æ¨¡å¼å›é€€å·²å®ç°
- [x] ä»£ç å·²ä¿å­˜

---

## ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹

### 1. å¤šæ ¼å¼æ”¯æŒ
- è‡ªåŠ¨è¯†åˆ«éŸ³é¢‘æ ¼å¼
- æ— éœ€æ‰‹åŠ¨è½¬æ¢

### 2. æ™ºèƒ½å›é€€
- éŸ³é¢‘åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨é™éŸ³æ¨¡å¼
- ä¸å½±å“è§†é¢‘ç”Ÿæˆ

### 3. è¯¦ç»†æ—¥å¿—
- æ˜¾ç¤ºéŸ³é¢‘åŠ è½½çŠ¶æ€
- æ˜¾ç¤ºé‡‡æ ·ç‡å’ŒéŸ³é¢‘å½¢çŠ¶
- ä¾¿äºè°ƒè¯•

### 4. æ€§èƒ½ä¼˜åŒ–
- soundfile æ¯” torchaudio æ›´å¿«
- å†…å­˜å ç”¨æ›´ä½

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ä½¿ç”¨éŸ³é¢‘ç”Ÿæˆ
1. å¯åŠ¨ Gradio UI
2. ä¸Šä¼ å›¾ç‰‡
3. ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼ˆMP3/WAVï¼‰
4. ç‚¹å‡»ç”Ÿæˆ

**ç»“æœ**: ç”Ÿæˆå¸¦æœ‰éŸ³é¢‘åŒæ­¥çš„è§†é¢‘

### ç¤ºä¾‹ 2: æ— éŸ³é¢‘ç”Ÿæˆ
1. å¯åŠ¨ Gradio UI
2. ä¸Šä¼ å›¾ç‰‡
3. ä¸ä¸Šä¼ éŸ³é¢‘
4. ç‚¹å‡»ç”Ÿæˆ

**ç»“æœ**: ç”Ÿæˆé™éŸ³è§†é¢‘ï¼ˆä½¿ç”¨ silent embedsï¼‰

---

## ğŸ” æ•…éšœæ’é™¤

### å¦‚æœä»ç„¶å‡ºç°éŸ³é¢‘é”™è¯¯

1. **æ£€æŸ¥ soundfile å®‰è£…**:
   ```bash
   python313\python.exe -c "import soundfile; print(soundfile.__version__)"
   ```

2. **æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶**:
   - ç¡®ä¿æ–‡ä»¶æœªæŸå
   - é¿å…ä¸­æ–‡è·¯å¾„
   - é¿å…ç‰¹æ®Šå­—ç¬¦

3. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**:
   - å¯ç”¨è°ƒè¯•æ¨¡å¼
   - æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯

4. **å¤‡ç”¨æ–¹æ¡ˆ**:
   ```bash
   # è½¬æ¢ä¸º WAV æ ¼å¼
   ffmpeg -i input.mp3 -ar 16000 -ac 1 output.wav
   ```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

1. **wanvideo_gradio_app.py** - ä¸»åº”ç”¨ï¼ˆå·²ä¿®å¤ï¼‰
2. **soundfileå®‰è£…å®Œæˆè¯´æ˜.md** - è¯¦ç»†è¯´æ˜
3. **éŸ³é¢‘åŠ è½½é”™è¯¯ä¿®å¤æŒ‡å—.md** - ä¿®å¤æŒ‡å—
4. **audio_loading_fix.py** - å¤‡ç”¨åŠ è½½å‡½æ•°

---

## ğŸ‰ æ€»ç»“

**æ‰€æœ‰éŸ³é¢‘åŠ è½½é—®é¢˜å·²å®Œå…¨è§£å†³ï¼**

- âœ… soundfile å·²å®‰è£…å¹¶é…ç½®
- âœ… éŸ³é¢‘åŠ è½½é€»è¾‘å·²ä¿®å¤
- âœ… æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼
- âœ… æ™ºèƒ½é”™è¯¯å¤„ç†
- âœ… é™éŸ³æ¨¡å¼å›é€€

**ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ InfiniteTalk çš„éŸ³é¢‘åŠŸèƒ½äº†ï¼** ğŸŠ
